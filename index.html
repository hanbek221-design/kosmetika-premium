<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TestMaster ‚Äî BUXORO_EDU (Cloud)</title>

  <!-- Telegram WebApp SDK (tahlil linkni Telegram ichida ochish uchun) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --grad1:#111827; --grad2:#0b1220;
      --card:rgba(255,255,255,.08); --glass:rgba(255,255,255,.06);
      --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.16);
      --primary:#60a5fa;--primary-2:#3b82f6;--accent:#a78bfa;
      --good:#22c55e;--bad:#ef4444;--amber:#f59e0b;
      --shadow:0 24px 60px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Arial,Segoe UI,Roboto,sans-serif; color:var(--text);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(96,165,250,.18), transparent 50%),
                  radial-gradient(1000px 600px at 85% 10%, rgba(167,139,250,.2), transparent 50%),
                  linear-gradient(160deg, var(--grad1), var(--grad2));
      min-height:100dvh;
    }
    .wrap{max-width:1100px;margin:28px auto;padding:18px}
    .brand{
      display:flex;align-items:center;gap:14px;padding:16px 18px;border-radius:20px;
      background:linear-gradient(90deg, rgba(96,165,250,.12), rgba(167,139,250,.12));
      border:1px solid var(--border); box-shadow:var(--shadow)
    }
    .logo{
      width:46px;height:46px;border-radius:12px;
      background:conic-gradient(from 0deg, #60a5fa, #a78bfa, #60a5fa);
      filter:brightness(1.05) saturate(1.2); box-shadow:0 10px 30px rgba(96,165,250,.35);
    }
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .brand small{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px; margin-bottom:16px
    }
    .panel-title{display:flex;align-items:center;gap:10px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--muted);font-size:12px}

    input{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--text); outline:none
    }
    input::placeholder{color:#94a3b8}
    label{display:block;margin:10px 0 6px;font-size:13px;color:var(--muted)}

    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer; transition:.15s
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(180deg, rgba(96,165,250,.35), rgba(96,165,250,.25)); border-color:#3b82f6}
    .btn.ghost{background:rgba(255,255,255,.04)}
    .btn.small{padding:7px 10px;font-size:13px}

    /* NEW: Telegram tahlil tugmasi */
    .btn.tg{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.35);
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .flex{display:flex;gap:10px;align-items:center}
    .space{flex:1}
    .hidden{display:none!important}

    .answer-pad{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .opt{
      padding:16px 22px;border-radius:14px;border:1px solid var(--border);min-width:76px;
      text-align:center;font-weight:800;font-size:18px;cursor:pointer;transition:.12s;
      background:rgba(255,255,255,.04); display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .opt .hk{
      font-size:11px; padding:2px 7px; border-radius:999px;
      border:1px solid var(--border); background:var(--glass); color:var(--muted);
      line-height:1; letter-spacing:.3px;
    }
    .opt[data-v="A"]{background:linear-gradient(180deg, rgba(96,165,250,.10), rgba(96,165,250,.06))}
    .opt[data-v="B"]{background:linear-gradient(180deg, rgba(34,197,94,.10), rgba(34,197,94,.06))}
    .opt[data-v="C"]{background:linear-gradient(180deg, rgba(245,158,11,.12), rgba(245,158,11,.06))}
    .opt[data-v="D"]{background:linear-gradient(180deg, rgba(244,114,182,.12), rgba(244,114,182,.06))}
    .opt:hover{transform:translateY(-2px)}
    .opt.active-admin{background:#fee2e2!important; border-color:#fca5a5!important; box-shadow:0 0 0 3px rgba(239,68,68,.25); transform:translateY(-2px)}
    .opt.active-user{background:#dbeafe!important; border-color:#60a5fa!important; box-shadow:0 0 0 3px rgba(59,130,246,.25); transform:translateY(-2px)}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}

    .tag{display:inline-block;padding:6px 10px;border-radius:999px;
      background:rgba(96,165,250,.15);border:1px solid rgba(96,165,250,.35);font-size:12px}

    .active-card{ outline:2px solid #60a5fa; border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.25) }
    .focus-q{ outline:2px solid #60a5fa; border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.25) }
    .my-row{ background: rgba(96,165,250,.15); }
    .adm-qrow{ margin:8px 0; padding:12px; border:1px dashed var(--border); border-radius:14px; }

    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>TestMaster ‚Äî BUXORO_EDU</h1>
        <small>Bulutga saqlanadigan professional test tizimi (Firestore)</small>
      </div>
      <div class="space"></div>
      <span class="pill">Cloud v1.7 ‚Äî Copy Only</span>
    </div>

    <div class="grid" id="authGrid">
      <!-- Foydalanuvchi: faqat ism -->
      <div class="card" id="authCard">
        <div class="panel-title">
          <strong>Foydalanuvchi</strong><span class="pill">Parolsiz (faqat ism)</span>
        </div>
        <div id="loginPanel" style="margin-top:10px">
          <label>Ismingizni yozing (istalgan ism, unikallik shart emas)</label>
          <input id="userName" placeholder="Masalan: Ali yoki Dilnoza" />
          <div class="flex" style="margin-top:10px">
            <button class="btn primary" id="btnUserLogin">Kirish</button>
            <div class="space"></div>
          </div>
          <div style="margin-top:10px;color:var(--muted);font-size:13px">
            Parol kerak emas. Xohlagan ismingizni kiriting va testlarni ishga tushiring.
          </div>
        </div>
      </div>

      <!-- Admin auth -->
      <div class="card" id="adminAuthCard">
        <div class="panel-title"><strong>Admin kirish</strong><span class="pill">Maxfiy</span></div>
        <div class="row" style="margin-top:8px">
          <div><input id="adminLogin" placeholder="admin login" /></div>
          <div><input id="adminCode" placeholder="kod" type="password" /></div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn primary" id="btnAdminLogin">Admin sifatida kirish</button>
          <div class="space"></div>
          <span style="color:var(--muted);font-size:13px">Admin qiymatlari ko‚Äòrsatilmaydi.</span>
        </div>
      </div>
    </div>

    <!-- Admin panel -->
    <div class="card hidden" id="adminCard">
      <div class="flex">
        <div class="panel-title"><strong>Admin ‚Äî boshqaruv</strong><span class="pill">Test yaratish / O‚Äòchirish / Hisobot</span></div>
        <div class="space"></div>
        <button class="btn small" id="btnLogout1">Chiqish</button>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="card" style="margin:0">
          <strong>Test yaratish</strong>
          <div style="margin-top:10px">
            <label>Test nomi</label><input id="tName" />
            <label style="margin-top:10px">Maxsus kod</label><input id="tCode" />
            <label style="margin-top:10px">Savollar soni</label><input id="tCount" type="number" value="5" min="1" />

            <!-- NEW: Telegram tahlil linki -->
            <label style="margin-top:10px">Telegram tahlil linki (ixtiyoriy)</label>
            <input id="tAnalysisLink" placeholder="https://t.me/c/3086001686/2/17260" />

            <div class="flex" style="margin-top:10px">
              <button class="btn" id="btnBuildGrid">Javob panellari</button>
              <button class="btn primary" id="btnSaveTest">Saqlash</button>
            </div>
            <div id="answerGrid" style="margin-top:10px"></div>
          </div>
        </div>

        <div class="card" style="margin:0">
          <strong>Saqlangan testlar</strong>
          <div class="panel-title" style="margin-top:8px"><span class="pill" id="testsCount">0 ta</span></div>
          <div id="adminTests" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- User panel -->
    <div class="card hidden" id="userCard">
      <div class="flex">
        <div class="panel-title"><strong>Testlar</strong><span class="pill">Tez kirish</span></div>
        <div class="space"></div>
        <span id="whoTag" class="tag"></span>
        <button class="btn small" id="btnLogout2">Chiqish</button>
      </div>

      <div class="flex" style="gap:8px;flex-wrap:wrap;margin-top:8px">
        <input id="codeInput" placeholder="Kod: masalan ENG101" style="max-width:260px">
        <button class="btn primary" id="btnStartByCode">Kodni ishga tushirish</button>

        <input id="nameSearch" placeholder="Nom bo‚Äòyicha qidirish..." style="min-width:220px">
        <button class="btn" id="btnClearSearch">Tozalash</button>

        <button class="btn" id="btnShowAll">Barcha testlar</button>
      </div>

      <div id="testsList" style="margin-top:12px"></div>
    </div>

    <!-- Test o‚Äòynash -->
    <div class="card hidden" id="playCard">
      <div class="flex">
        <div class="panel-title"><strong id="playTitle">Test</strong><span class="pill">Ishlash</span></div>
        <div class="space"></div>
        <button class="btn small" id="btnBack1">‚¨ÖÔ∏è Orqaga</button>
      </div>
      <div id="playBody" style="margin-top:12px"></div>
      <div class="flex" style="margin-top:12px">
        <div class="space"></div>
        <button class="btn primary" id="finishBtn">Yakunlash (Ctrl+Enter)</button>
      </div>
    </div>

    <!-- Natijalar -->
    <div class="card hidden" id="resultsCard">
      <div class="flex">
        <div class="panel-title"><strong id="resTitle">Natijalar</strong><span class="pill">Reyting</span></div>
        <div class="space"></div>
        <button class="btn small" id="btnBack2">‚¨ÖÔ∏è Orqaga</button>
      </div>
      <div id="leaderboardWrap" style="margin-top:12px"></div>
      <div id="detailWrap" style="margin-top:12px"></div>
      <div class="flex" style="margin-top:12px">
        <div class="space"></div>
        <!-- faqat nusxa olish -->
        <button class="btn" id="btnCopy">üìã Nusxa olish</button>
      </div>
    </div>
  </div>

  <footer style="opacity:.8;text-align:center;margin:18px 0">
    ¬© 2025 TestMaster ‚Äî Firestore Cloud (Copy Only)
  </footer>

<!-- ===== FIREBASE / FIRESTORE ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc,
    collection, getDocs, query, where, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  /* ‚Äî‚Äî‚Äî Config (Siz bergan yangi project) ‚Äî‚Äî‚Äî */
  const firebaseConfig = {
    apiKey: "AIzaSyBJNZlgnfh_UI96SLYX_RLLpElbYEozazA",
    authDomain: "buxoroedu-87f52.firebaseapp.com",
    projectId: "buxoroedu-87f52",
    storageBucket: "buxoroedu-87f52.appspot.com",
    messagingSenderId: "444519456395",
    appId: "1:444519456395:web:d8ca35794b173b9e78be8e",
    measurementId: "G-6T2K290W9Y"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ‚Äî‚Äî‚Äî Telegram init (ixtiyoriy) ‚Äî‚Äî‚Äî */
  try {
    const tg = window.Telegram?.WebApp;
    if (tg) tg.ready();
  } catch(e){}

  /* ‚Äî‚Äî‚Äî Helpers ‚Äî‚Äî‚Äî */
  const $ = (id)=>document.getElementById(id);
  function show(id,on=true){ const el=$(id); if(el) el.classList.toggle('hidden', !on) }
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }

  // NEW: Telegram tahlil link helperlari
  function normalizeTgLink(u){
    let url = (u||'').trim();
    if(!url) return '';
    if(url.startsWith('t.me/')) url = 'https://' + url;
    return url;
  }
  function isValidTgLink(url){
    if(!url) return true;
    return /^https:\/\/t\.me\//i.test(url);
  }
  function openTgLink(url){
    if(!url) return;
    const tg = window.Telegram?.WebApp;
    if(tg && typeof tg.openTelegramLink === 'function'){
      tg.openTelegramLink(url);
      return;
    }
    window.open(url, '_blank', 'noopener,noreferrer');
  }

  /* ‚Äî‚Äî‚Äî Qidiruv klaviatura holati ‚Äî‚Äî‚Äî */
  let __searchItems = [];
  let __searchIndex = -1;
  let __searchTimer = null;
  function setActiveCard(idx){
    __searchIndex = idx;
    document.querySelectorAll('#testsList .card').forEach(el=> el.classList.remove('active-card'));
    const el = document.getElementById('srch_'+idx);
    if(el){ el.classList.add('active-card'); el.scrollIntoView({ block:'nearest', behavior:'smooth' }); }
  }

  /* ‚Äî‚Äî‚Äî Cache ‚Äî‚Äî‚Äî */
  const CACHE = { tests:null, lastTestsAt:0 };
  async function cachedAllTests(force=false){
    if(!force && CACHE.tests && (Date.now()-CACHE.lastTestsAt<15000)) return CACHE.tests;
    const qs = await getDocs(collection(db,'tests')); const arr=[]; qs.forEach(d=>arr.push(d.data()));
    arr.sort((a,b)=>a.name.localeCompare(b.name));
    CACHE.tests=arr; CACHE.lastTestsAt=Date.now(); return arr;
  }

  /* ‚Äî‚Äî‚Äî Batch delete helper ‚Äî‚Äî‚Äî */
  async function __batchDeleteSnap(db, snap){
    const refs=[]; snap.forEach(d=>refs.push(d.ref));
    for(let i=0;i<refs.length;i+=450){
      const batch = writeBatch(db);
      refs.slice(i,i+450).forEach(r=>batch.delete(r));
      await batch.commit();
    }
  }

  /* ‚Äî‚Äî‚Äî DB qatlam (users yo‚Äòq) ‚Äî‚Äî‚Äî */
  const DB = {
    async saveTest({name, code, count, key, analysisLink}){
      await setDoc(doc(db,'tests', code), {
        name, code, count, key,
        analysisLink: analysisLink || '',
        updatedAt: Date.now()
      });
      CACHE.tests=null;
    },

    // NEW: faqat tahlil linkni merge bilan yangilash (key/count buzilmaydi)
    async setAnalysisLink(code, analysisLink){
      await setDoc(doc(db,'tests', code), {
        analysisLink: analysisLink || '',
        updatedAt: Date.now()
      }, { merge:true });
      CACHE.tests=null;
    },

    async allTests(){ return cachedAllTests(); },

    async getAttempts(code, login){
      const id = `${code}__${login.toLowerCase()}`;
      const snap = await getDoc(doc(db,'attempts', id));
      return snap.exists() ? (snap.data().count||0) : 0;
    },
    async incAttempt(code, login){
      const id = `${code}__${login.toLowerCase()}`;
      const n = await this.getAttempts(code, login)+1;
      await setDoc(doc(db,'attempts', id), { code, login, count:n, updatedAt: Date.now() });
      return n;
    },

    async getResults(code){
      const qs = await getDocs(query(collection(db,'results'), where('code','==',code)));
      const arr=[]; qs.forEach(d=>arr.push(d.data()));
      return arr.sort((a,b)=> b.score-a.score || a.date-b.date);
    },
    async upsertBestResult(rec){
      const id = `${rec.code}__${rec.login.toLowerCase()}`;
      const ref = doc(db,'results', id);
      const cur = await getDoc(ref);
      if(!cur.exists() || (rec.score > (cur.data().score||0))){
        await setDoc(ref, rec);
      }
    },
    async bestOfUser(code, login){
      const id = `${code}__${login.toLowerCase()}`;
      const snap = await getDoc(doc(db,'results', id));
      return snap.exists()? snap.data(): null;
    },

    async deleteTestDeep(code){
      const resSnap = await getDocs(query(collection(db,'results'), where('code','==',code)));
      await __batchDeleteSnap(db, resSnap);
      const attSnap = await getDocs(query(collection(db,'attempts'), where('code','==',code)));
      await __batchDeleteSnap(db, attSnap);
      await deleteDoc(doc(db,'tests', code));
      CACHE.tests=null;
    }
  };

  /* ‚Äî‚Äî‚Äî Sessiya / UI ‚Äî‚Äî‚Äî */
  let SESSION = { role:null, login:null };
  function logout(){
    SESSION={role:null,login:null};
    show('adminCard',false); show('userCard',false); show('playCard',false); show('resultsCard',false);
    show('authCard',true); show('adminAuthCard',true);
  }

  async function backToList(){
    if(SESSION.role==='user'){ show('playCard',false); show('resultsCard',false); show('userCard',true); await showAllTests(); }
    else if(SESSION.role==='admin'){ show('resultsCard',false); show('playCard',false); show('adminCard',true); await renderAdminLists(); }
    else { logout(); }
  }

  /* ‚Äî‚Äî‚Äî Parolsiz kirish (faqat ism) ‚Äî‚Äî‚Äî */
  async function loginUser(){
    const name = ($('userName').value||'').trim();
    if(!name) return alert('Ism kiriting');
    SESSION = { role:'user', login: name };
    const who = $('whoTag'); if(who) who.textContent = name;
    try{ localStorage.setItem('tm_last_login_name', name); }catch(e){}
    show('authCard',false); show('adminAuthCard',false); show('userCard',true);
    await showAllTests();
  }

  $('userName').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); loginUser(); } });
  $('btnUserLogin').addEventListener('click', loginUser);

  /* ‚Äî‚Äî‚Äî Admin auth ‚Äî‚Äî‚Äî */
  async function loginAdmin(){
    const login = $('adminLogin').value.trim();
    const code  = $('adminCode').value.trim();
    if(login.toLowerCase()==='javohir00' && code==='jude857'){
      SESSION = { role:'admin', login:'ADMIN' };
      show('authCard',false); show('adminAuthCard',false); show('adminCard',true);
      await renderAdminLists();
    } else alert('Admin login yoki kod xato');
  }
  $('btnAdminLogin').addEventListener('click', loginAdmin);

  /* ‚Äî‚Äî‚Äî Admin: JAVOB PANEL ‚Äî‚Äî‚Äî */
  let ADMIN_KEY = []; // ["A","C","B",...]

  function buildAnswerGrid(){
    const cnt = Math.max(1, parseInt(($('tCount').value||'1'),10));
    const wrap = $('answerGrid'); wrap.innerHTML='';
    ADMIN_KEY = new Array(cnt).fill(null);
    for(let i=0;i<cnt;i++){
      const row = document.createElement('div'); row.className='adm-qrow'; row.id = 'adm_q_'+i;
      row.innerHTML = `<div class="flex"><strong>${i+1}.</strong><div class="space"></div><span class="pill">To‚Äòg‚Äòri variantni tanlang</span></div>`;
      const pad = document.createElement('div'); pad.className='answer-pad';
      ['A','B','C','D'].forEach(ch=>{
        const b = document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.innerHTML = `<span class="hk">${ch}</span> ${ch}`;
        b.addEventListener('click', ()=>{
          [...pad.children].forEach(x=> x.classList.remove('active-admin'));
          b.classList.add('active-admin');
          ADMIN_KEY[i] = ch;
        });
        pad.appendChild(b);
      });
      row.appendChild(pad); wrap.appendChild(row);
    }
  }
  $('btnBuildGrid').addEventListener('click', buildAnswerGrid);
  let __cntTimer=null; $('tCount').addEventListener('input', ()=>{ clearTimeout(__cntTimer); __cntTimer=setTimeout(buildAnswerGrid, 200); });

  async function saveTest(){
    const name = ($('tName').value||'').trim();
    const code = ($('tCode').value||'').trim();
    const count = Math.max(1, parseInt(($('tCount').value||'1'),10));

    // NEW
    const analysisLink = normalizeTgLink(($('tAnalysisLink').value||'').trim());
    if(!isValidTgLink(analysisLink)) return alert('Telegram link xato. Masalan: https://t.me/c/3086001686/2/17260');

    if(!name || !code) return alert('Nom va kodni kiriting');
    if(!ADMIN_KEY.length || ADMIN_KEY.length!==count || ADMIN_KEY.some(v=>!v)){
      return alert('Har bir savol uchun A/B/C/D tanlang. Avval "Javob panellari" ni tuzing.');
    }

    await DB.saveTest({ name, code, count, key: ADMIN_KEY.slice(), analysisLink });
    alert('‚úÖ Test saqlandi');

    $('tName').value=''; $('tCode').value=''; $('tCount').value=5; $('tAnalysisLink').value='';
    $('answerGrid').innerHTML=''; ADMIN_KEY=[];
    await renderAdminLists();
  }
  $('btnSaveTest').addEventListener('click', saveTest);

  /* ‚Äî‚Äî‚Äî Admin ro‚Äòyxatlari ‚Äî‚Äî‚Äî */
  async function renderAdminLists(){
    const tests = await DB.allTests();
    $('testsCount').textContent = `${tests.length} ta`;
    await drawTestsListForAdmin();
  }

  async function drawTestsListForAdmin(){
    const tbox = $('adminTests'); tbox.innerHTML='';
    const tests = await DB.allTests();
    if(!tests.length){ tbox.innerHTML = '<div class="muted">Testlar yo‚Äòq</div>'; return; }

    for(const t of tests){
      const res = await DB.getResults(t.code);
      const participants = res.length;

      const div = document.createElement('div'); div.className='card'; div.style.margin='6px 0';

      div.innerHTML = `
        <div class="flex">
          <strong>${escapeHtml(t.name)}</strong>
          <div class="space"></div>
          <span class="pill">kod: ${escapeHtml(t.code)} ‚Ä¢ ${t.count} savol ‚Ä¢ üë• ${participants} ta</span>
        </div>

        <div class="flex" style="margin-top:8px;flex-wrap:wrap">
          <button class="btn" data-act="view">Natijalar</button>
          <button class="btn" data-act="del">O'chirish</button>
          <button class="btn" data-act="tg">Hisobot nusxasi</button>
          <button class="btn" data-act="setLink">Tahlil link</button>
          <div class="space"></div>
        </div>

        ${t.analysisLink ? `
          <div class="flex" style="margin-top:10px;flex-wrap:wrap">
            <span class="pill">Tahlil biriktirilgan</span>
            <div class="space"></div>
            <button class="btn tg" data-act="openLink">Test tahlilini ko‚Äòring</button>
          </div>` : `
          <div class="muted" style="margin-top:10px;font-size:13px">
            Tahlil link qo‚Äòshilmagan (xohlasangiz ‚ÄúTahlil link‚Äù tugmasi orqali qo‚Äòshing).
          </div>`
        }
      `;

      div.querySelector('[data-act="view"]').addEventListener('click', ()=> viewResults(t.code));
      div.querySelector('[data-act="del"]').addEventListener('click', (e)=> adminDeleteTest(t.code, e.target));
      div.querySelector('[data-act="tg"]').addEventListener('click', ()=> adminTgReport(t.code));

      // NEW: tahlil linkni qo‚Äòshish/yangilash
      div.querySelector('[data-act="setLink"]').addEventListener('click', async ()=>{
        const cur = t.analysisLink || '';
        const next = prompt('Telegram tahlil linkini kiriting:', cur);
        if(next === null) return;
        const normalized = normalizeTgLink(next);
        if(!isValidTgLink(normalized)) return alert('Telegram link xato. Masalan: https://t.me/c/3086001686/2/17260');
        await DB.setAnalysisLink(t.code, normalized);
        alert('‚úÖ Tahlil link saqlandi');
        await drawTestsListForAdmin();
      });

      const openBtn = div.querySelector('[data-act="openLink"]');
      if(openBtn) openBtn.addEventListener('click', ()=> openTgLink(t.analysisLink));

      tbox.appendChild(div);
    }
  }

  async function adminDeleteTest(code, el){
    if(!confirm(`'${code}' kodli testni VA unga tegishli barcha natija/urinishlarni o‚Äòchiraymi?`)) return;
    const oldText = el.textContent; el.textContent = 'O‚Äòchirilmoqda‚Ä¶'; el.disabled = true;
    try{ await DB.deleteTestDeep(code); alert('‚úÖ Test, results va attempts to‚Äòliq o‚Äòchirildi.'); await drawTestsListForAdmin(); }
    catch(e){ alert('‚ùå O‚Äòchirishda xatolik: '+e.message); }
    finally{ el.textContent = oldText; el.disabled = false; }
  }

  /* ‚Äî‚Äî‚Äî Admin: Hisobot (faqat nusxa olish) ‚Äî‚Äî‚Äî */
  async function adminTgReport(code){
    const all = await DB.allTests();
    const t = all.find(x=>x.code===code);
    if(!t){ alert('Test topilmadi'); return; }
    const res = await DB.getResults(code);

    if(!res.length){
      clipboardOrPrompt(`üß™ Test: ${t.name} (${t.code})\nüë• Ishtirokchilar: 0 ta\nHali natijalar yo‚Äòq.`);
      return;
    }

    let sumPct = 0; const lines = [];
    res.forEach((r,i)=>{
      const pct = Math.round((r.score/r.total)*100);
      sumPct += pct; const wrong = r.total - r.score;
      lines.push(`${i+1}) ${r.login} ‚Äî ${pct}%  ‚úÖ ${r.score} / ‚ùå ${wrong}`);
    });
    const avg = Math.round(sumPct / res.length);

    const head = [
      `üß™ Test: ${t.name} (${t.code})`,
      `üìù Savollar: ${t.count} ta`,
      `üë• Ishtirokchilar: ${res.length} ta`,
      `üìä O‚Äòrtacha: ${avg}%`,
      `---`
    ];
    clipboardOrPrompt(head.concat(lines).join('\n'));
  }

  /* ‚Äî‚Äî‚Äî User: QUICK ACCESS ‚Äî‚Äî‚Äî */
  $('codeInput').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); startByCode(); } });
  $('btnStartByCode').addEventListener('click', startByCode);
  $('nameSearch').addEventListener('input', ()=>{ clearTimeout(__searchTimer); __searchTimer = setTimeout(searchByName, 200); });
  $('nameSearch').addEventListener('keydown', (e)=>{
    if(!__searchItems.length) return;
    if(e.key === 'ArrowDown'){ e.preventDefault(); const next = (__searchIndex + 1) % __searchItems.length; setActiveCard(next); }
    else if(e.key === 'ArrowUp'){ e.preventDefault(); const prev = (__searchIndex - 1 + __searchItems.length) % __searchItems.length; setActiveCard(prev); }
    else if(e.key === 'Enter'){ e.preventDefault(); const t = __searchItems[__searchIndex]; if(t) startTest(t.code); }
  });
  $('btnClearSearch').addEventListener('click', ()=>{ const i = $('nameSearch'); if(i){ i.value=''; } $('testsList').innerHTML = '<div class="muted">Qidiruv tozalandi. ‚ÄúBarcha testlar‚Äù ni bosing yoki kod orqali ishga tushiring.</div>'; });
  $('btnShowAll').addEventListener('click', showAllTests);

  async function startByCode(){
    if(!SESSION.login) return alert('Avval ism bilan kiring');
    const code = ($('codeInput').value||'').trim();
    if(!code) return alert('Kod kiriting');
    const tests = await DB.allTests();
    const t = tests.find(x=> (x.code||'').toLowerCase() === code.toLowerCase());
    if(!t) return alert('Bunday kod topilmadi');
    await startTest(t.code);
  }

  async function searchByName(){
    if(!SESSION.login) return alert('Avval ism bilan kiring');
    const q = ($('nameSearch').value||'').trim().toLowerCase();
    const box = $('testsList'); box.innerHTML='';
    const tests = await DB.allTests();
    const filtered = q ? tests.filter(t => (t.name||'').toLowerCase().includes(q)) : [];
    __searchItems = filtered; __searchIndex = filtered.length ? 0 : -1;

    if(!filtered.length){ box.innerHTML = q ? '<div class="muted">Mos test topilmadi</div>' : '<div class="muted">Qidiruv matnini kiriting yoki ‚ÄúBarcha testlar‚Äù ni bosing</div>'; return; }

    const frag = document.createDocumentFragment();
    filtered.forEach((t,i)=>{
      const card = document.createElement('div'); card.className='card'; card.id = 'srch_'+i; card.style.margin='6px 0';
      card.innerHTML = `
        <div class="flex"><strong>${escapeHtml(t.name)}</strong><div class="space"></div><span class="pill">${t.count} savol</span></div>
        <div class="flex" style="margin-top:10px;flex-wrap:wrap">
          <button class="btn primary" data-act="start">Testni ishlash</button>
          <button class="btn" data-act="res">Natijalar</button>
          <div class="space"></div>
          <span class="tag">kod: ${escapeHtml(t.code)}</span>
        </div>

        ${t.analysisLink ? `
        <div class="flex" style="margin-top:10px;flex-wrap:wrap">
          <span class="pill">Tahlil</span>
          <div class="space"></div>
          <button class="btn tg" data-act="analysis">Test tahlilini ko‚Äòring</button>
        </div>` : ``}
      `;

      card.querySelector('[data-act="start"]').addEventListener('click', ()=> startTest(t.code));
      card.querySelector('[data-act="res"]').addEventListener('click', ()=> viewResults(t.code));

      const a = card.querySelector('[data-act="analysis"]');
      if(a) a.addEventListener('click', ()=> openTgLink(t.analysisLink));

      frag.appendChild(card);
    });
    box.appendChild(frag); setActiveCard(__searchIndex);
  }

  async function showAllTests(){
    if(!SESSION.login) return alert('Avval ism bilan kiring');
    const tests = await DB.allTests();
    const box = $('testsList'); box.innerHTML='';
    if(!tests.length){ box.innerHTML = '<div class="muted">Testlar yo ªq</div>'; return; }
    __searchItems = tests.slice(); __searchIndex = -1; renderTestsCards(tests);
  }
  function renderTestsCards(list){
    const box = $('testsList'); const frag = document.createDocumentFragment();
    list.forEach((t,i)=>{
      const card = document.createElement('div'); card.className='card'; card.id='srch_'+i; card.style.margin='6px 0';
      card.innerHTML = `
        <div class="flex"><strong>${escapeHtml(t.name)}</strong><div class="space"></div><span class="pill">${t.count} savol</span></div>
        <div class="flex" style="margin-top:10px;flex-wrap:wrap">
          <button class="btn primary" data-act="start">Testni ishlash</button>
          <button class="btn" data-act="res">Natijalar</button>
          <div class="space"></div>
          <span class="tag">kod: ${escapeHtml(t.code)}</span>
        </div>

        ${t.analysisLink ? `
        <div class="flex" style="margin-top:10px;flex-wrap:wrap">
          <span class="pill">Tahlil</span>
          <div class="space"></div>
          <button class="btn tg" data-act="analysis">Test tahlilini ko‚Äòring</button>
        </div>` : ``}
      `;

      card.querySelector('[data-act="start"]').addEventListener('click', ()=> startTest(t.code));
      card.querySelector('[data-act="res"]').addEventListener('click', ()=> viewResults(t.code));

      const a = card.querySelector('[data-act="analysis"]');
      if(a) a.addEventListener('click', ()=> openTgLink(t.analysisLink));

      frag.appendChild(card);
    });
    box.appendChild(frag);
  }

  /* ‚Äî‚Äî‚Äî Test o‚Äòynash ‚Äî‚Äî‚Äî */
  let PLAY = { code:null, key:[], count:0, chosen:[] };
  let PLAY_FOCUS = 0;

  async function startTest(code){
    if(!SESSION.login){ alert('Avval ism bilan kiring'); return; }
    const tests = await DB.allTests();
    const t = tests.find(x=>x.code===code);
    if(!t){ alert('Test topilmadi'); return; }
    const used = await DB.getAttempts(code, SESSION.login);
    if(used>=3){ alert('Bu testni 3 martadan ko‚Äòp ishlay olmaysiz.'); return; }

    PLAY = { code:code, key: t.key||[], count: t.count||0, chosen: new Array(t.count||0).fill(null) };
    $('playTitle').textContent = `${t.name} ‚Äî ${t.count} savol`;
    renderPlay();
    show('userCard', false); show('playCard', true);
  }

  function setFocus(i){
    if(PLAY.count<=0) return;
    if(i < 0) i = 0; if(i >= PLAY.count) i = PLAY.count - 1; PLAY_FOCUS = i;
    document.querySelectorAll('#playBody .card').forEach(el=> el.classList.remove('focus-q'));
    const row = document.getElementById('qrow_'+i);
    if(row){ row.classList.add('focus-q'); row.scrollIntoView({ block:'nearest', behavior:'smooth' }); }
  }
  function nextIndexFrom(i){ for(let k=i+1;k<PLAY.count;k++){ if(PLAY.chosen[k]==null) return k; } return Math.min(i+1, PLAY.count-1); }
  function selectOption(i, ch){
    const row = document.getElementById('qrow_'+i); if(!row) return;
    const pad = row.querySelector('.answer-pad'); if(!pad) return;
    [...pad.children].forEach(x=> x.classList.remove('active-user'));
    const btn = [...pad.children].find(x => (x.dataset.v === ch));
    if(btn) btn.classList.add('active-user');
    PLAY.chosen[i] = ch;
  }

  function renderPlay(){
    const body = $('playBody'); body.innerHTML='';
    for(let i=0;i<PLAY.count;i++){
      const row = document.createElement('div'); row.className='card'; row.style.margin='6px 0'; row.id = 'qrow_'+i;
      row.innerHTML = `<div class="flex"><strong>${i+1}.</strong><div class="space"></div><span class="pill">Variant tanlang</span></div>`;
      row.addEventListener('click', ()=> setFocus(i));
      const pad = document.createElement('div'); pad.className='answer-pad';
      ['A','B','C','D'].forEach(ch=>{
        const b = document.createElement('button'); b.className='opt'; b.dataset.v=ch; b.innerHTML = `<span class="hk">${ch}</span> ${ch}`;
        b.addEventListener('click', ()=>{ [...pad.children].forEach(x=> x.classList.remove('active-user')); b.classList.add('active-user'); PLAY.chosen[i]=ch; setFocus(nextIndexFrom(i)); });
        pad.appendChild(b);
      });
      row.appendChild(pad); body.appendChild(row);
    }
    setFocus(0);
  }

  // Global hotkeys
  document.addEventListener('keydown', (e)=>{
    const playOpen = !document.getElementById('playCard').classList.contains('hidden');
    if(!playOpen) return;

    if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); finishTest(); return; }
    const key = e.key.toLowerCase();
    if(key === 'arrowdown'){ e.preventDefault(); setFocus(Math.min(PLAY_FOCUS+1, PLAY.count-1)); return; }
    if(key === 'arrowup'){ e.preventDefault(); setFocus(Math.max(PLAY_FOCUS-1, 0)); return; }
    const map = { a:'A', b:'B', c:'C', d:'D' };
    if(map[key]){ e.preventDefault(); selectOption(PLAY_FOCUS, map[key]); setFocus(nextIndexFrom(PLAY_FOCUS)); }
  });

  async function finishTest(){
    if(!SESSION.login){ alert('Kirish talab qilinadi'); return; }
    if(PLAY.chosen.some(x=>x===null)){
      if(!confirm('Ba ºzi savollar belgilanmagan. Baribir yakunlaysizmi?')) return;
    }

    const details=[]; let score=0;
    for(let i=0;i<PLAY.count;i++){
      const correct = PLAY.key[i]; const chosen = PLAY.chosen[i]; const ok = chosen === correct; if(ok) score++;
      details.push({ q:i+1, chosen: chosen||'-', correct, ok });
    }
    await DB.incAttempt(PLAY.code, SESSION.login);
    const rec = { login: SESSION.login, code: PLAY.code, score, total: PLAY.count, details, date: Date.now() };
    await DB.upsertBestResult(rec);
    await viewResults(PLAY.code, rec);
  }

  /* ‚Äî‚Äî‚Äî Natijalar + matn tayyorlash ‚Äî‚Äî‚Äî */
  let __lastTgText = '';
  function makeTgText(test, rec){
    const lines = [];
    const pct = Math.round((rec.score/rec.total)*100);
    lines.push(`üß™ Test: ${test.name}${test.code ? ' ('+test.code+')':''}`);
    lines.push(`üë§ Ism: ${rec.login}`);
    lines.push(`üìä Natija: ${rec.score}/${rec.total} ‚Äî ${pct}%`);
    lines.push('---');
    rec.details.forEach(d=>{ lines.push(`${d.q}) tanlandi: ${d.chosen} | to‚Äòg‚Äòri: ${d.correct} ${d.ok?'‚úÖ':'‚ùå'}`); });
    return lines.join('\n');
  }
  function renderDetail(rec){
    let html = '<div class="card" style="margin:0">';
    html += `<strong>${escapeHtml(rec.login)}</strong> ‚Äî <span class="tag">${rec.score}/${rec.total}</span>`;
    html += '<div style="margin-top:10px"><table><thead><tr><th>#</th><th>Tanlangan</th><th>To ªg ªri</th><th>Holat</th></tr></thead><tbody>';
    rec.details.forEach(d=> html += `<tr><td>${d.q}</td><td>${d.chosen}</td><td>${d.correct}</td><td>${d.ok?'<span style="color:#22c55e">to‚Äòg‚Äòri</span>':'<span style="color:#ef4444">xato</span>'}</td></tr>`);
    html += '</tbody></table></div></div>';
    return html;
  }

  async function viewResults(code, justMade=null){
    show('userCard', false); show('playCard', false); show('resultsCard', true);
    const tests = await DB.allTests(); const t = tests.find(x=>x.code===code); if(!t){ alert('Test topilmadi'); return; }
    $('resTitle').textContent = `${t.name} ‚Äî Natijalar`;

    const arr = await DB.getResults(code);
    const lb = $('leaderboardWrap'); lb.innerHTML='';
    if(!arr.length){ lb.innerHTML = '<div class="muted">Natijalar yo ªq</div>'; }
    else {
      let h = '<table><thead><tr><th>#</th><th>Ism</th><th>Ball</th><th>Foiz</th><th>Sana</th></tr></thead><tbody>';
      arr.forEach((r,i)=>{
        const mine = (SESSION.login && r.login === SESSION.login);
        const pct = Math.round((r.score/r.total)*100);
        h += `<tr class="${mine ? 'my-row' : ''}">
                <td>${i+1}</td>
                <td>${escapeHtml(r.login)}</td>
                <td><strong>${r.score}/${r.total}</strong></td>
                <td>${pct}%</td>
                <td>${new Date(r.date).toLocaleString()}</td>
              </tr>`;
      });
      h += '</tbody></table>'; lb.innerHTML = h;
    }

    const dw = $('detailWrap');
    const mine = justMade || (SESSION.login ? await DB.bestOfUser(code, SESSION.login) : null);
    if(mine){ dw.innerHTML = renderDetail(mine); __lastTgText = makeTgText(t, mine); }
    else { dw.innerHTML = '<div class="muted">O‚Äòzingizning oxirgi urinish tafsilotlari ko‚Äòrinmadi.</div>'; __lastTgText = ''; }

    // NEW: Natijada ham tahlil tugmasi chiqsin
    if(t.analysisLink){
      const block = document.createElement('div');
      block.className = 'card';
      block.style.marginTop = '12px';
      block.innerHTML = `
        <div class="flex" style="flex-wrap:wrap">
          <strong>Test tahlili</strong>
          <div class="space"></div>
          <button class="btn tg" id="btnOpenAnalysis">Test tahlilini ko‚Äòring</button>
        </div>
        <div class="muted" style="margin-top:8px;font-size:13px">Tahlil Telegram link orqali ochiladi.</div>
      `;
      dw.appendChild(block);
      block.querySelector('#btnOpenAnalysis').addEventListener('click', ()=> openTgLink(t.analysisLink));
    }
  }

  /* ‚Äî‚Äî‚Äî FAQAT NUSXA OLISH ‚Äî‚Äî‚Äî */
  function clipboardOrPrompt(text){
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text)
        .then(()=> alert('‚úÖ siz (copy qildingiz) Nusxa olindi. telegramga guruhizga kiring va vstavit qiling!(hozir) (Telegramga boring hozir nusxa oldiz , telegramga borasiz vstavit qilasiz).'))
        .catch(()=> prompt('Matnni qo‚Äòlda nusxalang (Ctrl+C):', text));
    } else {
      prompt('Matnni qo‚Äòlda nusxalang (Ctrl+C):', text);
    }
  }

  function copyResult(){
    if(!__lastTgText){
      alert('Avval o‚Äòzingizning natijangizni oching (yoki testni tugating).');
      return;
    }
    clipboardOrPrompt(__lastTgText);
  }

  // Qidiruv maydoni bo'sh bo'lganda yordamchi yozuv
  $('testsList').innerHTML = '<div class="muted">Kodni kiriting yoki ‚ÄúBarcha testlar‚Äù ni bosing</div>';

  // Tugma handlerlari
  $('btnBack1').addEventListener('click', backToList);
  $('btnBack2').addEventListener('click', backToList);
  $('btnLogout1').addEventListener('click', logout);
  $('btnLogout2').addEventListener('click', logout);
  $('finishBtn').addEventListener('click', finishTest);
  $('btnCopy').addEventListener('click', copyResult);

  // Boot
  (function boot(){ try{ const last = localStorage.getItem('tm_last_login_name'); if(last){ $('userName').value = last; } }catch(e){} })();

  // Start holat
  logout();
</script>
</body>
</html>
